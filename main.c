#include "chacha20.h"

void xor(uint8_t *input_block, uint8_t *keystream_block, uint8_t *output, size_t len)
{
	for (size_t i = 0; i < len; i++)
	{
		output[i] = input_block[i] ^ keystream_block[i];
	}
}

uint8_t *chacha20(uint8_t key[32], uint32_t block_counter, uint8_t nonce[12], uint8_t *text, size_t text_len)
{
	uint8_t *output = malloc(text_len);
	if (!output)
	{
		printf("malloc failed\n");
		return NULL;
	}

	size_t num_blocks = (text_len + 63) / 64;
	// printf("[+] number of blocks = %ld\n", num_blocks);

	for (size_t j = 0; j < num_blocks; j++)
	{
		size_t offset = j * 64;
		size_t block_len = (text_len - offset >= 64) ? 64 : (text_len - offset);
		printf("[+] block length: %ld\n", block_len);

		uint8_t keystream_block[64] = {0};
		chacha20_block(key, block_counter + j, nonce, keystream_block);
		printf("[+] Serialized block:\n");
		print_bytes(keystream_block, 64);

		// printf("\n[+] keystream:\n");
		// print_bytes(keystream, 64);

		uint8_t *block = &text[offset];
		xor(block, keystream_block, output + offset, block_len);

		// block_len = nombre d'octets Ã  traiter dans ce bloc (utile pour le dernier bloc)
	}
	return output;
}

int main()
{
	uint8_t key[32] = {0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f};
	uint32_t block_counter = 1;
	uint8_t nonce[12] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x4a, 0x00, 0x00, 0x00, 0x00};

	uint8_t plaintext[] = {
		0x4c, 0x61, 0x64, 0x69, 0x65, 0x73, 0x20, 0x61,
		0x6e, 0x64, 0x20, 0x47, 0x65, 0x6e, 0x74, 0x6c,
		0x65, 0x6d, 0x65, 0x6e, 0x20, 0x6f, 0x66, 0x20,
		0x74, 0x68, 0x65, 0x20, 0x63, 0x6c, 0x61, 0x73,
		0x73, 0x20, 0x6f, 0x66, 0x20, 0x27, 0x39, 0x39,
		0x3a, 0x20, 0x49, 0x66, 0x20, 0x49, 0x20, 0x63,
		0x6f, 0x75, 0x6c, 0x64, 0x20, 0x6f, 0x66, 0x66,
		0x65, 0x72, 0x20, 0x79, 0x6f, 0x75, 0x20, 0x6f,
		0x6e, 0x6c, 0x79, 0x20, 0x6f, 0x6e, 0x65, 0x20,
		0x74, 0x69, 0x70, 0x20, 0x66, 0x6f, 0x72, 0x20,
		0x74, 0x68, 0x65, 0x20, 0x66, 0x75, 0x74, 0x75,
		0x72, 0x65, 0x2c, 0x20, 0x73, 0x75, 0x6e, 0x73,
		0x63, 0x72, 0x65, 0x65, 0x6e, 0x20, 0x77, 0x6f,
		0x75, 0x6c, 0x64, 0x20, 0x62, 0x65, 0x20, 0x69,
		0x74, 0x2e};

	size_t plaintext_len = sizeof(plaintext);
	uint8_t *ciphertext = chacha20(key, block_counter, nonce, plaintext, plaintext_len);
	if (!ciphertext)
		return 1;

	printf("\nCiphertext:\n");
	print_bytes(ciphertext, plaintext_len);

	printf("\n[+] Decrypting ciphertext...\n");
	uint8_t *decrypted_ciphertext = chacha20(key, block_counter, nonce, ciphertext, plaintext_len);
	printf("Plaintext was:\n%s\n", decrypted_ciphertext);

	return 0;
}
